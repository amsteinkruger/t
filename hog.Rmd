---
title: "Hog"
output: html_document
---

####0. Libraries

```{r libraries, warning = FALSE, error = FALSE, message = FALSE}

library(knitr)
library(tidyverse)
library(janitor)
library(broom)
library(reshape2)

```

####1. Data

```{r data_read, cache = FALSE}
knitr::read_chunk('data.R')
```

```{r data}
```

####2. Functions

```{r functions_read}

knitr::read_chunk('functions.R')

```

```{r functions}
```

####3. Set-Up

```{r set_read}

knitr::read_chunk('set.R')

```

```{r set}
```

####4. Hog Function

```{r fun_read}

knitr::read_chunk('fun.R')

```

```{r fun}
```

####5. Hog Runs

```{r runs}

# Build a home for results of runs.
results = list()

# Loop through parameter sets.
for(i in 1:6){par = select(pars, i)
              output = fun(par)
              output$Run = i
              output$Scenario = ifelse(output$Run < 4, "w/ Aquaculture", "w/o Aquaculture")
              output$Estimate = ifelse(output$Run == 1 | output$Run == 4, "Central", "Outer")
              results[[i]] = output}

# Go from list to dataframe for easier processing.
results = bind_rows(results)
<<<<<<< HEAD

# Build a home for results of runs with effort.
results_e = list()

# Loop through parameter sets for effort and price reduction.
for(i in 1:length(pars_arb)){par = select(pars_arb, i)
              output = fun(par)
              output$Run = i
              results_e[[i]] = output}

# Go from list to dataframe for easier processing.
results_e = bind_rows(results_e)
=======
>>>>>>> 450f881c0c764c3295b86a2109b87c6b09ab44bd

```

####6. Hog Outputs

Visualization and tables.

<<<<<<< HEAD
```{r vis_read}
knitr::read_chunk('vis.R')
```
=======
```{r vis}

# Stock and catch of reproductive biomass in numbers and mass.
results_sum = filter(results, Age > 3) %>%
  mutate(Biomass = fun_l_w(pars$default[4], fun_a_l(Age - 0.5, pars$default[1], pars$default[2], pars$default[3]),  pars$default[5]) / 1000 * Result) %>% 
  group_by(Year, Variable, Run, Scenario, Estimate) %>% # Run, 
  summarize(SumNum = sum(Result), SumBio = sum(Biomass)) %>% 
  mutate(LogNum = log(SumNum + 1), LogBio = log(SumBio + 1)) %>% 
  ungroup() %>% 
  mutate(Run = as.factor(Run)) %>% 
  unite("Estimate | Scenario", Estimate, Scenario, sep = " | ", remove = FALSE)

# Plot the summary numbers.
plot_fig = 
  ggplot(filter(results_sum, Variable == "Numbers")) +
  geom_line(aes(x = Year, y = SumBio, group = Run, color = Scenario, linetype = Estimate), size = 1.25) + #group = Run,
  scale_color_brewer(palette = "Set1", direction = -1) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA), labels = scales::comma) +
  scale_x_continuous(expand = c(0, 0), labels = scales::comma) +  
  labs(x = "Year", y = "Tonnes of Reproductive Biomass") +
  theme_classic()

#ggsave("plot_fig.png", plot_fig, dpi = 300, width = 6.5, height = 6.5)

# Revenues and costs of both sectors.
results_sum_pi = results %>% 
  filter(Estimate == "Central" & Variable == "Poaching Revenue" |
         Estimate == "Central" & Variable == "Poaching Cost" |
         Estimate == "Central" & Variable == "Poaching Profit" | 
         Estimate == "Central" & Variable == "Aquaculture Revenue" | 
         Estimate == "Central" & Variable == "Aquaculture Cost" |
         Estimate == "Central" & Variable == "Aquaculture Profit") %>% 
  unite("Variable | Run", Variable, Run, sep = " | ", remove = FALSE)

plot_rc = 
  ggplot(results_sum_pi) +
  geom_line(aes(x = Year, y = Result, group = `Variable | Run`, color = `Variable | Run`), size = 1.25) +
  scale_color_brewer(palette = "Set1", direction = -1) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA), labels = scales::comma) +
  scale_x_continuous(expand = c(0, 0), labels = scales::comma) +  
  labs(x = "Year", y = "Fat Stacks") +
  theme_classic() +
  facet_wrap(vars(Scenario))

plot_pi = 
  ggplot(filter(results_sum_pi, Variable == "Poaching Profit"| Variable == "Aquaculture Profit" & Scenario == "w/ Aquaculture")) +
  geom_col(aes(x = Year, y = Result, fill = Variable), position = "dodge") +
  scale_fill_brewer(palette = "Set1", direction = -1) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(expand = c(0, 0), breaks = seq(1, 10), labels = scales::comma) +  
  labs(x = "Year", y = "Fat Stacks") +
  theme_classic() +
  facet_wrap(vars(Scenario))
>>>>>>> 450f881c0c764c3295b86a2109b87c6b09ab44bd

```{r vis}
```

```{r tab}



```

####Appendix: Equations and Variable, Parameter Definitions
Put these in the earlier sections!

#####Ages to Lengths | Edad y Tamaño

$L(t) = L_\infty ( 1 - e^{ - K ( t - t_0 )})$

Variable   | Definition                   | Value
---------- | ---------------------------  | ---------
*L*        | Length (Centimeters)         | 
$L_\infty$ | Maximum Length (Centimeters) | 180.0000
$K_{fi}$   | Catabolic Constant (INAPESCA)| 0.155000
$K_{aq}$   | Catabolic Constant (EOF)     | 0.228560
*t*        | Age (Years)                  | 
$t_0$      | Age, *L* = 0                 | 0.000000

#####Lengths to Weights | Tamaño y Peso

$W = aL^b$

Variable   | Definition                  | Value
---------- | --------------------------- | -------
*W*        | Weight (Kilograms)          |
*L*        | Length (Centimeters)        |
*a*        | Parameter                   | 0.000004128
*b*        | Parameter                   | 3.246740000

#####Ages to Marginal Natural Mortalities | Edad y Mortalidad Natural Marginal

Marginal Mortality at Age:
$N_a = N_{a-1}e^{-M_a}$

Ages        | $-M_a$ 
----------- | -----------
0 - 2.5     | 0.549
3.5 - 19.5  | 0.069
20.5 - 26.5 | 0.411

#####Ages to Bycatch Mortalities

$N_{2.5, t} = N_{1.5, t} * b$

$b = 0.20$

#####Ages to Poaching Mortalities (Selectivities)

$s = \frac{a}{e^{b - m * l}}$

Variable   | Definition                          | Value
---------- | ----------------------------------- | ---------------------------
a          | Shape Parameter                     | 0.95
b          | Shape Parameter                     | 19.88
m          | Shape Parameter                     | 0.13
l          | Length (Centimeters)                |


#####Numbers at Age to Recruitment | Números por Edad y Reclutamiento

$n_{0, t} = \frac{\alpha N_{a, t-1}}{[1 + (N_{a, t-1} / \beta)]^{\delta}}$

Variable   | Definition                          | Value
---------- | ----------------------------------- | ---------------------------
$N_{0, t}$ | Recruits                            |
$N_{a, t}$ | Cohort of Age *a*                   |
$\alpha$   | Parameter                           | 131.35
$\beta$    | Parameter                           | 3.07
$\delta$   | Parameter                           | 1.639951478


#####Inverse Demand Specification

$p_{g, t} = \beta_0 + \beta_1Y_t + g_{a}^{\beta_2}$

Variable   | Definition                                
---------- | -----------------------------------------
$p_{g, t}$ | USD2018 / Gram of Dried Buche            
$Y_t$      | Tonnes of Dried Buche (Total Production)
$g_{a}$    | Grams of Dried Buche (Individual Product)
$\beta_0$  | Coefficient (Choke Price)
$\beta_1$  | Coefficient (Quantity Elasticity)
$\beta_2$  | Coefficient (Exponential Price Premium)

#####Effort

$E_{t} = E_{t - 1} + \eta\pi_{t-1}$

Variable   | Definition                               
---------- | -----------------------------------------
$E_t$      | Effort in Boat-Years
$\eta$     | Resistance Parameter (i.e. limit to entry, exit)
$\pi$      | Profit (USD2018)

#####Catch

$y_{a, t} = qE_ts_{a}n_{a, t}$

Variable        | Definition                               
--------------- | -----------------------------------------
$y_{a, t}$      | Numbers Caught by Cohort and Time
q               | Catchability
$E_t$           | Effort in Boat-Years
$s_a$           | Proportional Selectivity
$n_{a, t}$      | Numbers by Cohort and Time

#####Stock

$N_t = \sum (n_{a, t - 1} - n_{a, t - 1}m_{a, t - 1} - n_{a, t - 1}m_{a, t - 1}b_{a, t - 1} - y_{a, t - 1}) + n_{0, t - 1}$
